# Cribl Best Practice Rules
#
# This file contains validation rules for Cribl Stream and Edge configurations.
# Rules are evaluated during configuration analysis to identify issues and
# optimization opportunities.
#
# Format:
#   - id: Unique identifier (e.g., rule-bp-pipeline-ordering)
#   - name: Human-readable name
#   - category: performance | security | reliability | best_practice
#   - description: What the rule checks
#   - rationale: Why this matters
#   - check_type: config_pattern | metric_threshold | relationship
#   - validation_logic: Expression to evaluate
#   - severity_if_violated: critical | high | medium | low
#   - documentation_link: URL to Cribl docs
#   - cribl_version_min: Optional minimum version (e.g., "4.0.0")
#   - cribl_version_max: Optional maximum version
#   - enabled: true | false

rules:
  # ========================================
  # Best Practice Rules (Migrated from hardcoded)
  # ========================================

  - id: rule-bp-no-deprecated-regex
    name: "Deprecated 'regex' function"
    category: best_practice
    description: "Pipeline uses deprecated 'regex' function"
    rationale: "The 'regex' function is deprecated in favor of 'regex_extract' which provides better performance and functionality"
    check_type: config_pattern
    validation_logic: "function.id equals: regex"
    severity_if_violated: medium
    documentation_link: "https://docs.cribl.io/stream/regex-extract-function"
    cribl_version_min: "4.0.0"
    enabled: false  # Disabled - already handled by hardcoded _check_deprecated_functions()

  - id: rule-bp-no-deprecated-code
    name: "Deprecated 'code' function"
    category: best_practice
    description: "Pipeline uses deprecated 'code' function"
    rationale: "The 'code' function is deprecated in favor of 'eval' which provides better safety and performance"
    check_type: config_pattern
    validation_logic: "function.id equals: code"
    severity_if_violated: medium
    documentation_link: "https://docs.cribl.io/stream/eval-function"
    cribl_version_min: "4.0.0"
    enabled: false  # Disabled - already handled by hardcoded _check_deprecated_functions()

  # ========================================
  # Security Rules (Migrated from hardcoded)
  # ========================================

  - id: rule-sec-no-hardcoded-password
    name: "Hardcoded password detected"
    category: security
    description: "Configuration contains hardcoded password"
    rationale: "Hardcoded credentials pose a security risk. Use environment variables or secrets management instead"
    check_type: config_pattern
    validation_logic: "password exists: password"
    severity_if_violated: high
    documentation_link: "https://docs.cribl.io/stream/securing-and-monitoring/#environment-variables"
    enabled: false  # Disabled - already handled by hardcoded _check_security_misconfigurations()

  - id: rule-sec-no-hardcoded-token
    name: "Hardcoded API token detected"
    category: security
    description: "Configuration contains hardcoded API token"
    rationale: "Hardcoded credentials pose a security risk. Use environment variables or secrets management instead"
    check_type: config_pattern
    validation_logic: "token exists: token"
    severity_if_violated: high
    documentation_link: "https://docs.cribl.io/stream/securing-and-monitoring/#environment-variables"
    enabled: false  # Disabled - already handled by hardcoded _check_security_misconfigurations()

  - id: rule-sec-no-hardcoded-secret
    name: "Hardcoded secret detected"
    category: security
    description: "Configuration contains hardcoded secret"
    rationale: "Hardcoded credentials pose a security risk. Use environment variables or secrets management instead"
    check_type: config_pattern
    validation_logic: "secret exists: secret"
    severity_if_violated: high
    documentation_link: "https://docs.cribl.io/stream/securing-and-monitoring/#environment-variables"
    enabled: false  # Disabled - already handled by hardcoded _check_security_misconfigurations()

  - id: rule-sec-no-hardcoded-api-key
    name: "Hardcoded API key detected"
    category: security
    description: "Configuration contains hardcoded API key"
    rationale: "Hardcoded credentials pose a security risk. Use environment variables or secrets management instead"
    check_type: config_pattern
    validation_logic: "apiKey exists: apiKey"
    severity_if_violated: high
    documentation_link: "https://docs.cribl.io/stream/securing-and-monitoring/#environment-variables"
    enabled: false  # Disabled - already handled by hardcoded _check_security_misconfigurations()

  - id: rule-sec-require-tls
    name: "Unencrypted connection detected"
    category: security
    description: "Output uses unencrypted HTTP connection"
    rationale: "Data transmitted over HTTP is not encrypted and could be intercepted. Use HTTPS for secure communication"
    check_type: config_pattern
    validation_logic: "url matches: ^https://"
    severity_if_violated: medium
    documentation_link: "https://docs.cribl.io/stream/securing-and-monitoring/#encrypting-data-in-transit"
    enabled: false  # Disabled - already handled by hardcoded _check_security_misconfigurations()

  # ========================================
  # Relationship Rules (Migrated from hardcoded)
  # ========================================

  - id: rule-rel-no-orphaned-routes
    name: "Route references non-existent pipeline"
    category: reliability
    description: "Route references a pipeline that doesn't exist"
    rationale: "Orphaned routes will fail at runtime. Ensure all referenced pipelines exist"
    check_type: relationship
    validation_logic: "references:pipelines"
    severity_if_violated: high
    documentation_link: "https://docs.cribl.io/stream/routes"
    enabled: false  # Disabled - already handled by hardcoded _validate_route_configuration()

  # ========================================
  # Performance Rules (New for Phase 2B)
  # ========================================

  - id: rule-perf-filter-early
    name: "Filtering should occur early in pipeline"
    category: performance
    description: "Pipeline does not start with filtering/sampling functions"
    rationale: "Early filtering reduces data volume processed by downstream functions, improving throughput by 20-50%"
    check_type: config_pattern
    validation_logic: "functions.0.id matches: ^(drop|sampling|aggreg|eval)"
    severity_if_violated: low
    documentation_link: "https://docs.cribl.io/stream/pipelines-performance"
    cribl_version_min: "4.0.0"
    enabled: true

  - id: rule-perf-limit-regex
    name: "Excessive regex operations in pipeline"
    category: performance
    description: "Pipeline contains more than 2 regex-based functions"
    rationale: "Regex operations are computationally expensive and can reduce throughput by 50%+. Consider using structured parsing or field extraction functions"
    check_type: config_pattern
    validation_logic: "regex_count <= 2"
    severity_if_violated: medium
    documentation_link: "https://docs.cribl.io/stream/performance-tuning"
    cribl_version_min: "4.0.0"
    enabled: true

  - id: rule-perf-pipeline-length
    name: "Pipeline has too many functions"
    category: performance
    description: "Pipeline contains more than 15 functions"
    rationale: "Long pipelines with many functions can impact processing performance and are harder to maintain. Consider splitting into multiple pipelines or using route-based processing"
    check_type: config_pattern
    validation_logic: "functions.length > 15"
    severity_if_violated: low
    documentation_link: "https://docs.cribl.io/stream/pipelines"
    cribl_version_min: "4.0.0"
    enabled: true

  # ========================================
  # Reliability Rules (New for Phase 2C)
  # ========================================

  - id: rule-rel-route-output-required
    name: "Route missing output destination"
    category: reliability
    description: "Route does not specify an output destination"
    rationale: "Routes without outputs will drop events. Ensure all routes have valid output configurations"
    check_type: config_pattern
    validation_logic: "output exists: output"
    severity_if_violated: high
    documentation_link: "https://docs.cribl.io/stream/routes"
    enabled: true

  - id: rule-rel-route-filter-required
    name: "Route missing filter expression"
    category: reliability
    description: "Route does not specify a filter expression"
    rationale: "Routes without filters will match all events, which may not be intended. Explicit filters improve clarity and prevent unintended routing"
    check_type: config_pattern
    validation_logic: "filter exists: filter"
    severity_if_violated: low
    documentation_link: "https://docs.cribl.io/stream/routes"
    enabled: true

  - id: rule-rel-route-final-required
    name: "No final catch-all route defined"
    category: reliability
    description: "Route configuration lacks a final catch-all route"
    rationale: "Without a final route with filter='true', unmatched events may be dropped unexpectedly"
    check_type: config_pattern
    validation_logic: "final_route exists: true"
    severity_if_violated: low
    documentation_link: "https://docs.cribl.io/stream/routes"
    enabled: false  # This needs special handling at the route collection level

  # ========================================
  # Configuration Quality Rules (New for Phase 2D)
  # ========================================

  - id: rule-quality-pipeline-complexity
    name: "Pipeline complexity too high"
    category: best_practice
    description: "Pipeline contains too many functions (>10), consider splitting"
    rationale: "Complex pipelines are harder to maintain and troubleshoot. Consider breaking into smaller, focused pipelines"
    check_type: config_pattern
    validation_logic: "functions.length > 10"
    severity_if_violated: low
    documentation_link: "https://docs.cribl.io/stream/pipelines"
    enabled: true

  - id: rule-quality-too-many-routes
    name: "Too many routes defined"
    category: best_practice
    description: "Route configuration has more than 20 routes"
    rationale: "Large numbers of routes can be difficult to manage and may impact routing performance. Consider consolidating or organizing routes"
    check_type: config_pattern
    validation_logic: "routes_count > 20"
    severity_if_violated: low
    documentation_link: "https://docs.cribl.io/stream/routes"
    enabled: false  # This needs collection-level evaluation

  - id: rule-quality-pipeline-name-clarity
    name: "Pipeline name lacks clarity"
    category: best_practice
    description: "Pipeline has a generic or unclear name"
    rationale: "Clear, descriptive pipeline names improve maintainability and team collaboration"
    check_type: config_pattern
    validation_logic: "id not_matches: ^(pipeline|test|temp|new|default)"
    severity_if_violated: low
    documentation_link: "https://docs.cribl.io/stream/pipelines"
    enabled: true

  # ========================================
  # Advanced Security Rules (New for Phase 2E)
  # ========================================

  - id: rule-sec-pii-field-masking
    name: "PII field should be masked"
    category: security
    description: "Pipeline contains PII fields without masking"
    rationale: "Sensitive PII data (SSN, credit card, phone numbers, email) should be masked or redacted to prevent data leakage and ensure compliance with privacy regulations"
    check_type: config_pattern
    validation_logic: "field_name not_matches: (ssn|social_security|credit_card|cc_number|phone|email|passport|driver_license|dob|date_of_birth)"
    severity_if_violated: high
    documentation_link: "https://docs.cribl.io/stream/mask-function"
    cribl_version_min: "4.0.0"
    enabled: true

  - id: rule-sec-data-classification
    name: "Sensitive data requires classification"
    category: security
    description: "Pipeline processes sensitive data without classification tags"
    rationale: "Data classification helps enforce appropriate security controls and retention policies. Sensitive data should be tagged for tracking and compliance"
    check_type: config_pattern
    validation_logic: "classification exists: classification"
    severity_if_violated: medium
    documentation_link: "https://docs.cribl.io/stream/data-classification"
    enabled: false  # Requires enterprise features

  - id: rule-sec-encryption-at-rest
    name: "Sensitive output should use encryption"
    category: security
    description: "Output destination for sensitive data lacks encryption configuration"
    rationale: "Data at rest should be encrypted to protect against unauthorized access. Enable encryption for S3, Azure, or file-based outputs"
    check_type: config_pattern
    validation_logic: "encryption.enabled exists: true"
    severity_if_violated: medium
    documentation_link: "https://docs.cribl.io/stream/securing-and-monitoring/#encryption-at-rest"
    enabled: false  # Needs output-specific evaluation

  - id: rule-sec-tls-version
    name: "Outdated TLS version detected"
    category: security
    description: "Output uses TLS 1.0 or 1.1 which are deprecated"
    rationale: "TLS 1.0 and 1.1 have known security vulnerabilities. Use TLS 1.2 or higher for secure communications"
    check_type: config_pattern
    validation_logic: "tls.version not_matches: ^(1.0|1.1)"
    severity_if_violated: high
    documentation_link: "https://docs.cribl.io/stream/securing-and-monitoring/#tls-configuration"
    enabled: false  # Requires TLS config inspection

  - id: rule-sec-authentication-required
    name: "Output missing authentication"
    category: security
    description: "Output destination does not require authentication"
    rationale: "All outputs should require authentication to prevent unauthorized data access. Configure credentials, API keys, or certificates"
    check_type: config_pattern
    validation_logic: "auth exists: auth"
    severity_if_violated: high
    documentation_link: "https://docs.cribl.io/stream/destinations"
    enabled: false  # Needs context-aware evaluation
